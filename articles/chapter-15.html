<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="alda">
<title>Chapter 15: Extending the Cox regression model • alda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Chapter 15: Extending the Cox regression model">
<meta property="og:description" content="alda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">alda</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tips-amp-tricks">Tips &amp; Tricks</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tips-amp-tricks">
    <a class="dropdown-item" href="../articles/longitudinal-data-organization.html">Longitudinal data organization</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-textbook-examples">Textbook examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-textbook-examples">
    <h6 class="dropdown-header" data-toc-skip>Longitudinal mixed effects modelling</h6>
    <a class="dropdown-item" href="../articles/chapter-2.html">Chapter 2</a>
    <a class="dropdown-item" href="../articles/chapter-3.html">Chapter 3</a>
    <a class="dropdown-item" href="../articles/chapter-4.html">Chapter 4</a>
    <a class="dropdown-item" href="../articles/chapter-5.html">Chapter 5</a>
    <a class="dropdown-item" href="../articles/chapter-6.html">Chapter 6</a>
    <a class="dropdown-item" href="../articles/chapter-7.html">Chapter 7</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Longitudinal structural equation modelling</h6>
    <a class="dropdown-item" href="../articles/chapter-8.html">Chapter 8</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Survival analysis</h6>
    <a class="dropdown-item" href="../articles/chapter-9.html">Chapter 9</a>
    <a class="dropdown-item" href="../articles/chapter-10.html">Chapter 10</a>
    <a class="dropdown-item" href="../articles/chapter-11.html">Chapter 11</a>
    <a class="dropdown-item" href="../articles/chapter-12.html">Chapter 12</a>
    <a class="dropdown-item" href="../articles/chapter-13.html">Chapter 13</a>
    <a class="dropdown-item" href="../articles/chapter-14.html">Chapter 14</a>
    <a class="dropdown-item" href="../articles/chapter-15.html">Chapter 15</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mccarthy-m-g/alda/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Chapter 15: Extending the Cox regression model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mccarthy-m-g/alda/blob/HEAD/vignettes/articles/chapter-15.Rmd" class="external-link"><code>vignettes/articles/chapter-15.Rmd</code></a></small>
      <div class="d-none name"><code>chapter-15.Rmd</code></div>
    </div>

    
    
<div class="alert alert-warning">
<p>This chapter is under construction.</p>
</div>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mccarthy-m-g.github.io/alda/">alda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/slider" class="external-link">slider</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vctrs.r-lib.org/" class="external-link">vctrs</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'vctrs'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     data_frame</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">muhaz</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="time-varying-predictors">15.1 Time-Varying Predictors<a class="anchor" aria-label="anchor" href="#time-varying-predictors"></a>
</h2>
<p>Table 15.1, page 548:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TODO: Clean up code and make table</span></span>
<span><span class="va">model_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">used_cocaine_age</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span></span>
<span>    <span class="va">birthyr</span> <span class="op">+</span> <span class="va">early_marijuana_use</span> <span class="op">+</span> <span class="va">early_drug_use</span>,</span>
<span>  data <span class="op">=</span> <span class="va">first_cocaine</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model B ----</span></span>
<span><span class="va">first_cocaine_pp</span> <span class="op">&lt;-</span> <span class="va">first_cocaine</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span></span>
<span>    <span class="co"># {survival} uses the counting process method for time-varying predictors,</span></span>
<span>    <span class="co"># so we need to construct intervals for the ages at which different events</span></span>
<span>    <span class="co"># occurred. These intervals are left-censored, so we start with the end</span></span>
<span>    <span class="co"># time; we also only require unique intervals, so duplicate ages should be</span></span>
<span>    <span class="co"># removed.</span></span>
<span>    age_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">used_cocaine_age</span>, <span class="va">used_marijuana_age</span>, <span class="va">used_drugs_age</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    age_start <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">age_end</span>, default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    <span class="co"># Time-varying predictors should be lagged so that they describe an individual's</span></span>
<span>    <span class="co"># status in the immediately prior year.</span></span>
<span>    used_cocaine <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">==</span> <span class="va">used_cocaine_age</span> <span class="op">&amp;</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">0</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    used_marijuana <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">&gt;</span> <span class="va">used_marijuana_age</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    used_drugs <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">&gt;</span> <span class="va">used_drugs_age</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Keep time-invariant predictors from the person-level data</span></span>
<span>    <span class="va">birthyr</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">age_start</span>, .before <span class="op">=</span> <span class="va">age_end</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">age_start</span>, <span class="va">age_end</span>, <span class="va">used_cocaine</span><span class="op">)</span> <span class="op">~</span></span>
<span>    <span class="va">birthyr</span> <span class="op">+</span> <span class="va">used_marijuana</span> <span class="op">+</span> <span class="va">used_drugs</span>,</span>
<span>  data <span class="op">=</span> <span class="va">first_cocaine_pp</span>,</span>
<span>  ties <span class="op">=</span> <span class="st">"efron"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## This method with tmerge() also works</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html" class="external-link">tmerge</a></span><span class="op">(</span></span>
<span>  <span class="va">first_cocaine</span>, <span class="va">first_cocaine</span>,</span>
<span>  id <span class="op">=</span> <span class="va">id</span>,</span>
<span>  used_cocaine <span class="op">=</span> <span class="fu">event</span><span class="op">(</span><span class="va">used_cocaine_age</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span>,</span>
<span>  used_marijuana <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">used_marijuana_age</span><span class="op">)</span>,</span>
<span>  used_drugs <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">used_drugs_age</span><span class="op">)</span>,</span>
<span>  options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    tstartname <span class="op">=</span> <span class="st">"age_start"</span>,</span>
<span>    tstopname <span class="op">=</span> <span class="st">"age_end"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `tstop`.</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `tstart`.</span></span>
<span><span class="co">#&gt; Warning in tmerge(first_cocaine, first_cocaine, id = id, used_cocaine =</span></span>
<span><span class="co">#&gt; event(used_cocaine_age, : replacement of variable 'used_marijuana'</span></span>
<span><span class="co">#&gt; Warning in tmerge(first_cocaine, first_cocaine, id = id, used_cocaine =</span></span>
<span><span class="co">#&gt; event(used_cocaine_age, : replacement of variable 'used_drugs'</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3,086 × 18</span></span></span>
<span><span class="co">#&gt;    id    used_cocaine_age censor birthyr early_marijuana_use early_drug_use</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 5                   41      1       0                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 5                   41      1       0                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 5                   41      1       0                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 8                   32      1      10                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 9                   36      1       5                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 9                   36      1       5                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 11                  41      1       0                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 12                  32      0       4                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 12                  32      0       4                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 13                  39      1       3                   0              0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3,076 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 12 more variables: used_marijuana &lt;int&gt;, used_marijuana_age &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   sold_marijuana &lt;dbl&gt;, sold_marijuana_age &lt;dbl&gt;, used_drugs &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   used_drugs_age &lt;dbl&gt;, sold_drugs &lt;dbl&gt;, sold_drugs_age &lt;dbl&gt;, rural &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   age_start &lt;dbl&gt;, age_end &lt;dbl&gt;, used_cocaine &lt;dbl&gt;</span></span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">age_start</span>, <span class="va">age_end</span>, <span class="va">used_cocaine</span><span class="op">)</span> <span class="op">~</span></span>
<span>    <span class="va">birthyr</span> <span class="op">+</span> <span class="va">used_marijuana</span> <span class="op">+</span> <span class="va">used_drugs</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html" class="external-link">tmerge</a></span><span class="op">(</span></span>
<span>    <span class="va">first_cocaine</span>, <span class="va">first_cocaine</span>,</span>
<span>    id <span class="op">=</span> <span class="va">id</span>,</span>
<span>    used_cocaine <span class="op">=</span> <span class="fu">event</span><span class="op">(</span><span class="va">used_cocaine_age</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span>,</span>
<span>    used_marijuana <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">used_marijuana_age</span><span class="op">)</span>,</span>
<span>    used_drugs <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">used_drugs_age</span><span class="op">)</span>,</span>
<span>    options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      tstartname <span class="op">=</span> <span class="st">"age_start"</span>,</span>
<span>      tstopname <span class="op">=</span> <span class="st">"age_end"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  ties <span class="op">=</span> <span class="st">"efron"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `tstop`.</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `tstart`.</span></span>
<span><span class="co">#&gt; Warning in tmerge(first_cocaine, first_cocaine, id = id, used_cocaine =</span></span>
<span><span class="co">#&gt; event(used_cocaine_age, : replacement of variable 'used_marijuana'</span></span>
<span><span class="co">#&gt; Warning in tmerge(first_cocaine, first_cocaine, id = id, used_cocaine =</span></span>
<span><span class="co">#&gt; event(used_cocaine_age, : replacement of variable 'used_drugs'</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `tstop`.</span></span>
<span><span class="co">#&gt; Warning: Unknown or uninitialised column: `tstart`.</span></span>
<span><span class="co">#&gt; Warning in tmerge(first_cocaine, first_cocaine, id = id, used_cocaine =</span></span>
<span><span class="co">#&gt; event(used_cocaine_age, : replacement of variable 'used_marijuana'</span></span>
<span><span class="co">#&gt; Warning in tmerge(first_cocaine, first_cocaine, id = id, used_cocaine =</span></span>
<span><span class="co">#&gt; event(used_cocaine_age, : replacement of variable 'used_drugs'</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(age_start, age_end, used_cocaine) ~ birthyr + </span></span>
<span><span class="co">#&gt;     used_marijuana + used_drugs, data = tmerge(first_cocaine, </span></span>
<span><span class="co">#&gt;     first_cocaine, id = id, used_cocaine = event(used_cocaine_age, </span></span>
<span><span class="co">#&gt;         1 - censor), used_marijuana = tdc(used_marijuana_age), </span></span>
<span><span class="co">#&gt;     used_drugs = tdc(used_drugs_age), options = list(tstartname = "age_start", </span></span>
<span><span class="co">#&gt;         tstopname = "age_end")), ties = "efron")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 3086, number of events= 382 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                    coef exp(coef) se(coef)      z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; birthyr         0.10741   1.11340  0.02145  5.008  5.5e-07 ***</span></span>
<span><span class="co">#&gt; used_marijuana  2.55176  12.82972  0.28095  9.082  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; used_drugs      1.85387   6.38446  0.12921 14.347  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; birthyr            1.113    0.89815     1.068     1.161</span></span>
<span><span class="co">#&gt; used_marijuana    12.830    0.07794     7.397    22.252</span></span>
<span><span class="co">#&gt; used_drugs         6.384    0.15663     4.956     8.225</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.876  (se = 0.008 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 856  on 3 df,   p=&lt;2e-16</span></span>
<span><span class="co">#&gt; Wald test            = 451.1  on 3 df,   p=&lt;2e-16</span></span>
<span><span class="co">#&gt; Score (logrank) test = 1039  on 3 df,   p=&lt;2e-16</span></span>
<span></span>
<span><span class="co"># Model C and D ----</span></span>
<span><span class="va">first_cocaine_pp_C</span> <span class="op">&lt;-</span> <span class="va">first_cocaine</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span></span>
<span>    age_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="va">used_cocaine_age</span>,</span>
<span>          <span class="va">used_marijuana_age</span>,</span>
<span>          <span class="va">used_drugs_age</span>,</span>
<span>          <span class="va">sold_marijuana_age</span>,</span>
<span>          <span class="va">sold_drugs_age</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    age_start <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">age_end</span>, default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    <span class="co"># Time-varying predictors should be lagged so that they describe an individual's</span></span>
<span>    <span class="co"># status in the immediately prior year.</span></span>
<span>    used_cocaine <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">==</span> <span class="va">used_cocaine_age</span> <span class="op">&amp;</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">0</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    used_marijuana <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">&gt;</span> <span class="va">used_marijuana_age</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    used_drugs <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">&gt;</span> <span class="va">used_drugs_age</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    sold_marijuana <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">&gt;</span> <span class="va">sold_marijuana_age</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    sold_drugs <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">age_end</span> <span class="op">&gt;</span> <span class="va">sold_drugs_age</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span>, missing <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Keep time-invariant predictors from the person-level data</span></span>
<span>    <span class="va">birthyr</span>,</span>
<span>    <span class="va">early_marijuana_use</span>,</span>
<span>    <span class="va">early_drug_use</span>,</span>
<span>    <span class="va">rural</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">age_start</span>, .before <span class="op">=</span> <span class="va">age_end</span><span class="op">)</span></span>
<span></span>
<span><span class="va">first_cocaine_model_C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">age_start</span>, <span class="va">age_end</span>, <span class="va">used_cocaine</span><span class="op">)</span> <span class="op">~</span></span>
<span>    <span class="va">birthyr</span> <span class="op">+</span> <span class="va">used_marijuana</span> <span class="op">+</span> <span class="va">used_drugs</span> <span class="op">+</span> <span class="va">sold_marijuana</span> <span class="op">+</span> <span class="va">sold_drugs</span>,</span>
<span>  data <span class="op">=</span> <span class="va">first_cocaine_pp_C</span>,</span>
<span>  ties <span class="op">=</span> <span class="st">"efron"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">first_cocaine_model_C</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="va">early_marijuana_use</span> <span class="op">+</span> <span class="va">early_drug_use</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="imputation-strategies-for-time-varying-predictors">15.1.3 Imputation Strategies for Time-Varying Predictors<a class="anchor" aria-label="anchor" href="#imputation-strategies-for-time-varying-predictors"></a>
</h3>
<p>In Section 15.1.3 Singer and Willet (2003) discuss imputation
strategies for time-varying predictors using a subset of unpublished
data from Hall, Havassy, and Wasserman (1990), who measured the relation
between the number of days until relapse to cocaine use and several
predictors that might be associated with relapse in a sample of 104
newly abstinent cocaine users who recently completed an
abstinence-oriented treatment program. Former cocaine users were
followed for up to 12 weeks post-treatment or until they used cocaine
for 7 consecutive days. Self-reported abstinence was confirmed at each
interview by the absence of cocaine in urine specimens.</p>
<p>For this example we use the <code>cocaine_relapse_2</code> data set,
a person-period data frame with 1248 rows and 7 columns:</p>
<ul>
<li>
<code>id</code>: Participant ID.</li>
<li>
<code>days</code>: Number of days until relapse to cocaine use or
censoring. Relapse was defined as 4 or more days of cocaine use during
the week preceding an interview. Study dropouts and lost participants
were coded as relapsing to cocaine use, with the number of days until
relapse coded as occurring the week after the last follow-up interview
attended.</li>
<li>
<code>censor</code>: Censoring status (0 = relapsed, 1 =
censored).</li>
<li>
<code>needle</code>: Binary indicator for whether cocaine was ever
used intravenously.</li>
<li>
<code>base_mood</code>: Total score on the positive mood subscales
(Activity and Happiness) of the Mood Questionnaire (Ryman, Biersner,
&amp; LaRocco, 1974), taken at an intake interview during the last week
of treatment. Each item used a five point Likert score (ranging from 0 =
not at all, to 4 = extremely).</li>
<li>
<code>followup</code>: Week of follow-up interview.
-<code>mood</code>: Total score on the positive mood subscales (Activity
and Happiness) of the Mood Questionnaire (Ryman, Biersner, &amp;
LaRocco, 1974), taken during follow-up interviews each week
post-treatment. Each item used a five point Likert score (ranging from 0
= not at all, to 4 = extremely).</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">cocaine_relapse_2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 1,248</span></span>
<span><span class="co">#&gt; Columns: 7</span></span>
<span><span class="co">#&gt; $ id        <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> 550, 550, 550, 550, 550, 550, 550, 550, 550, 550, 550, 550, …</span></span>
<span><span class="co">#&gt; $ censor    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></span>
<span><span class="co">#&gt; $ days      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 83, 83, 83, 83, 83, 83, 83, 83, 83, 83, 83, 83, 83, 83, 83, …</span></span>
<span><span class="co">#&gt; $ needle    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, …</span></span>
<span><span class="co">#&gt; $ base_mood <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 29, 25, 25, 25, …</span></span>
<span><span class="co">#&gt; $ followup  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, …</span></span>
<span><span class="co">#&gt; $ mood      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 23, 27, 28, 31, 29, 32, 33, 28, 36, 33, 33, 24, 31, 19, 29, …</span></span></code></pre></div>
<p>Because time to relapse was measured in days but follow-up interviews
were conducted only once a week, the cocaine relapse data in its current
form fails to meet the data requirement for time-varying predictors: For
each unique event time in <code>days</code> we do not know the
time-varying <code>mood</code> scores—for everyone still at risk at—at
each of those moments. Thus, in order to meet this data requirement we
must generate predictor histories that provide near-daily
<code>mood</code> scores for each participant.</p>
<p>In the proceeding steps we will develop three Cox regression models
fitted to the cocaine relapse data to illustrate and compare different
imputation strategies for time-varying predictors. Each includes the
number of <code>days</code> until relapse to cocaine use as the outcome
variable; the time-invariant predictor <code>needle</code>; and a
different time-varying variable representing the predictor for total
score on the positive mood subscales of the Mood Questionnaire (Ryman,
Biersner, &amp; LaRocco, 1974), for which we will explore the following
popular imputation strategies suggested by Singer and Willet (2003):</p>
<ol style="list-style-type: decimal">
<li>Carry forward each mood score until the next one is available.</li>
<li>Interpolate between adjacent mood scores.</li>
<li>Compute a moving average based on the most recent and several past
mood scores.</li>
</ol>
<div class="section level4">
<h4 id="exploratory-data-analysis">Exploratory Data Analysis<a class="anchor" aria-label="anchor" href="#exploratory-data-analysis"></a>
</h4>
<p>We begin by exploring the time-invariant variables in the
<code>cocaine_relapse_2</code> data. Because it will be convenient for
one of the Cox regression models fitted later on, we will do so using a
person-level version of the <code>cocaine_relapse_2</code> data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_pl</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">followup</span>,</span>
<span>    names_prefix <span class="op">=</span> <span class="st">"mood_"</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">mood</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">cocaine_relapse_2_pl</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 104</span></span>
<span><span class="co">#&gt; Columns: 17</span></span>
<span><span class="co">#&gt; $ id        <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> 550, 604, 608, 631, 513, 531, 533, 536, 599, 542, 564, 573, …</span></span>
<span><span class="co">#&gt; $ censor    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></span>
<span><span class="co">#&gt; $ days      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 83, 83, 83, 83, 82, 82, 82, 82, 82, 81, 81, 81, 81, 81, 81, …</span></span>
<span><span class="co">#&gt; $ needle    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, …</span></span>
<span><span class="co">#&gt; $ base_mood <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 29, 25, 37, 39, 33, 27, 10, 27, 28, 19, 35, 32, 32, 31, 31, …</span></span>
<span><span class="co">#&gt; $ mood_1    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 23, 31, 40, 42, 43, 14, 16, 22, 29, 31, 30, 27, 27, 41, 40, …</span></span>
<span><span class="co">#&gt; $ mood_2    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 27, 19, 37, 22, 25, 11, 26, 21, 28, 25, 33, 26, 27, NA, NA, …</span></span>
<span><span class="co">#&gt; $ mood_3    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 28, 29, 36, 38, 34, 2, 37, 24, 25, 28, 33, 24, 23, 38, 31, 4…</span></span>
<span><span class="co">#&gt; $ mood_4    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 31, 24, 36, 41, 42, 8, 17, 24, NA, 20, 33, 29, 22, 37, NA, N…</span></span>
<span><span class="co">#&gt; $ mood_5    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 29, 22, 32, 41, 46, 3, 30, NA, NA, 23, 26, 21, 26, 24, 28, N…</span></span>
<span><span class="co">#&gt; $ mood_6    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 32, 22, 35, 42, 42, 3, 15, 22, 16, 29, 35, 28, 28, 27, 28, 2…</span></span>
<span><span class="co">#&gt; $ mood_7    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 33, NA, 34, 42, 46, 5, 16, NA, 22, 27, 35, 22, 24, 27, 31, 2…</span></span>
<span><span class="co">#&gt; $ mood_8    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 28, 20, 35, 42, 46, 3, 15, 23, 23, NA, 33, 28, 17, 28, 22, 3…</span></span>
<span><span class="co">#&gt; $ mood_9    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 36, 31, 29, 46, 47, 2, 21, 19, 24, NA, 29, 25, 14, 31, 24, 3…</span></span>
<span><span class="co">#&gt; $ mood_10   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 33, 33, 36, NA, NA, 2, 14, 21, 16, 31, NA, NA, NA, 37, 33, N…</span></span>
<span><span class="co">#&gt; $ mood_11   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 33, 30, 30, 47, 28, 0, 20, 15, 18, 23, 26, 25, 17, 38, 29, 2…</span></span>
<span><span class="co">#&gt; $ mood_12   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 24, NA, 36, 43, 44, 0, 16, 18, 16, 21, NA, 25, 19, 34, 30, 2…</span></span></code></pre></div>
<p>A total of 62 newly abstinent cocaine users (59.6%) relapsed to
cocaine use within 12 weeks of completing the abstinence-oriented
treatment program.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_pl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span>relapsed <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">count</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   relapsed count proportion</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>        0    42      0.404</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>        1    62      0.596</span></span></code></pre></div>
<p>Most of those users relapsed early-on during the follow-up
period.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cocaine_relapse_2_pl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span> <span class="op">*</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span>relapsed <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Across the sample there were 38 unique event times.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We will use these event times later on during the imputation procedure for</span></span>
<span><span class="co"># Model B. It is important they are sorted in ascending order for this</span></span>
<span><span class="co"># procedure, so we do so here for convenience while creating the object.</span></span>
<span><span class="va">event_times</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2_pl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">days</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">censor_times</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2_pl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">censor</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">days</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">event_times</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html" class="external-link">discard</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="va">.x</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">censor_times</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 38</span></span></code></pre></div>
<p>A total of 69 participants (66.3%) reported having previously used
cocaine intravenously.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_pl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">needle</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">count</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   needle count proportion</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      0    35      0.337</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      1    69      0.663</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="model-a-time-invariant-baseline">Model A: Time-Invariant Baseline<a class="anchor" aria-label="anchor" href="#model-a-time-invariant-baseline"></a>
</h4>
<p><strong>Model A</strong> uses the time-invariant predictor assessing
the respondent’s mood score just before release from treatment.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">days</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span> <span class="va">needle</span> <span class="op">+</span> <span class="va">base_mood</span>, </span>
<span>  data <span class="op">=</span> <span class="va">cocaine_relapse_2_pl</span>,</span>
<span>  ties <span class="op">=</span> <span class="st">"efron"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_A</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(days, 1 - censor) ~ needle + base_mood, </span></span>
<span><span class="co">#&gt;     data = cocaine_relapse_2_pl, ties = "efron")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 104, number of events= 62 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                coef exp(coef)  se(coef)      z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; needle     1.020734  2.775232  0.314068  3.250  0.00115 **</span></span>
<span><span class="co">#&gt; base_mood -0.003748  0.996259  0.014709 -0.255  0.79886   </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; needle       2.7752     0.3603    1.4996     5.136</span></span>
<span><span class="co">#&gt; base_mood    0.9963     1.0038    0.9679     1.025</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.63  (se = 0.036 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 12.51  on 2 df,   p=0.002</span></span>
<span><span class="co">#&gt; Wald test            = 10.6  on 2 df,   p=0.005</span></span>
<span><span class="co">#&gt; Score (logrank) test = 11.51  on 2 df,   p=0.003</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="model-b">Model B:<a class="anchor" aria-label="anchor" href="#model-b"></a>
</h4>
<p>For <strong>Model B</strong> we return to the person-period version
of the <code>cocaine_relapse_2</code> data and explore the first
imputation strategy suggested by Singer and Willet (2003): Carrying
forward each mood score until the next one is available. For this
procedure we will also lag the mood score predictor by one
week—associating, for example, the first followup with baseline mood
scores, the second followup with the first followup’s mood scores, and
so forth.
<!-- TODO, explain why lag is used: "As Allison (2010) points out, however, the direction of causality here is ambiguous, because a person cannot work when he is in jail. One way of addressing this problem is to use instead a lagged value of employment, from the previous week for example." ([Fox and Weisberg, p. 11](zotero://select/library/items/V5DMHDX8)) ([pdf](zotero://open-pdf/library/items/2KQMEBUS?page=11&annotation=35HDG864)) --></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_prevweek</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    mood_previous_week <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">mood</span>, default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">base_mood</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    mood_previous_week_fill <span class="op">=</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_fill_missing.html" class="external-link">vec_fill_missing</a></span><span class="op">(</span></span>
<span>      <span class="va">mood_previous_week</span>, direction <span class="op">=</span> <span class="st">"down"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">cocaine_relapse_2_prevweek</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,248 × 9</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   id [104]</span></span></span>
<span><span class="co">#&gt;    id    censor  days needle base_mood followup  mood mood_previous_week</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 550        1    83      1        29        1    23                 29</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 550        1    83      1        29        2    27                 23</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 550        1    83      1        29        3    28                 27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 550        1    83      1        29        4    31                 28</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 550        1    83      1        29        5    29                 31</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 550        1    83      1        29        6    32                 29</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 550        1    83      1        29        7    33                 32</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 550        1    83      1        29        8    28                 33</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 550        1    83      1        29        9    36                 28</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 550        1    83      1        29       10    33                 36</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,238 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: mood_previous_week_fill &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Next, to prepare the <code>cocaine_relapse_2_prevweek</code> data for
modelling, we want to transform it into a data set that has the number
of days until relapse in a <strong>counting process</strong> or (start,
stop) format, which is a person-period format where:</p>
<ul>
<li>Each row of the transformed data set represents an “at-risk” time
interval (<code>day_start</code>, <code>day_end</code>], which is open
on the left and closed on the right.</li>
<li>The <code>event</code> variable for each row is 1 if the time
interval ends with an event and 0 otherwise.</li>
<li>Variable values for each row are the values that apply over that
time interval.</li>
</ul>
<p>The start and end points for each time interval are determined by the
vector of unique <code>event_times</code>, which we defined earlier. For
censored data, the end point of the final time interval is determined by
the time of censorship—which is not included in the vector of unique
event times—so it needs to be handled separately.</p>
<p>Transforming the <code>cocaine_relapse_2_prevweek</code> data into a
counting process format is a two-step process. First we create the
counting process structure, with columns for participant ID, start time,
stop time, and event status for each record. We also add a
<code>week</code> variable indicating the week that each record occurred
in, which will be important for the second step in the process. Note
that this step could done using either the person-period or person-level
versions of the <code>cocaine_relapse_2</code> data however, for
readability we use the person-level data below. The same result can be
obtained using the person-period data by wrapping the calls to
<code>days</code> and <code>censor</code> with
<code><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique()</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_prevweek_cp</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2_pl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span></span>
<span>    <span class="co"># For censored data the final day should be a participant's days value, so</span></span>
<span>    <span class="co"># we need to concatenate their days to the vector of event times. The call</span></span>
<span>    <span class="co"># to unique() around the vector removes the duplicate for uncensored data in</span></span>
<span>    <span class="co"># the final time interval.</span></span>
<span>    day_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">event_times</span><span class="op">[</span><span class="va">event_times</span> <span class="op">&lt;=</span> <span class="va">days</span><span class="op">]</span>, <span class="va">days</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    day_start <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">day_end</span>, default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    event <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">day_end</span> <span class="op">==</span> <span class="va">days</span> <span class="op">&amp;</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">0</span>, true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">day_end</span> <span class="op">/</span> <span class="fl">7</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">day_start</span>, .after <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cocaine_relapse_2_prevweek_cp</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2,805 × 5</span></span></span>
<span><span class="co">#&gt;    id    day_start day_end event  week</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 501           0       1     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 501           1       2     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 501           2       3     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 501           3       4     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 501           4       6     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 501           6       7     0     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 501           7       8     0     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 501           8       9     0     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 501           9      10     0     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 501          10      11     0     2</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2,795 more rows</span></span></span></code></pre></div>
<p>Second, we join the <code>cocaine_relapse_2_prevweek</code> data to
the counting process structure by <code>id</code> and <code>week</code>,
giving us the counting process formatted data with each time-varying
predictor’s values occurring at the appropriate time interval for each
participant. Finally, to match the text, we will rename our mood score
variable to <code>week_mood</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_prevweek_cp</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2_prevweek_cp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">cocaine_relapse_2_prevweek</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="va">id</span>, <span class="va">week</span> <span class="op">==</span> <span class="va">followup</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>week_mood <span class="op">=</span> <span class="va">mood_previous_week_fill</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cocaine_relapse_2_prevweek_cp</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2,805 × 12</span></span></span>
<span><span class="co">#&gt;    id    day_start day_end event  week censor  days needle base_mood  mood</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 501           0       1     0     1      0    12      1        29    34</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 501           1       2     0     1      0    12      1        29    34</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 501           2       3     0     1      0    12      1        29    34</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 501           3       4     0     1      0    12      1        29    34</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 501           4       6     0     1      0    12      1        29    34</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 501           6       7     0     2      0    12      1        29    19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 501           7       8     0     2      0    12      1        29    19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 501           8       9     0     2      0    12      1        29    19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 501           9      10     0     2      0    12      1        29    19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 501          10      11     0     2      0    12      1        29    19</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2,795 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: mood_previous_week &lt;dbl&gt;, week_mood &lt;dbl&gt;</span></span></span></code></pre></div>
<div class="alert alert-note">
<p>The <strong>survival</strong> package also comes with two utility
functions, <code><a href="https://rdrr.io/pkg/survival/man/survSplit.html" class="external-link">survSplit()</a></code> and <code><a href="https://rdrr.io/pkg/survival/man/tmerge.html" class="external-link">tmerge()</a></code>, that can
be used to transform data into a counting process format. For further
discussion, see
<code><a href="https://cran.rstudio.com/web/packages/survival/vignettes/timedep.pdf" class="external-link">vignette("timedep", package="survival")</a></code>.</p>
</div>
<p>Now we can fit Model B.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">day_start</span>, <span class="va">day_end</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">needle</span> <span class="op">+</span> <span class="va">week_mood</span>, </span>
<span>  data <span class="op">=</span> <span class="va">cocaine_relapse_2_prevweek_cp</span>,</span>
<span>  ties <span class="op">=</span> <span class="st">"efron"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_B</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(day_start, day_end, event) ~ needle + week_mood, </span></span>
<span><span class="co">#&gt;     data = cocaine_relapse_2_prevweek_cp, ties = "efron")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 2805, number of events= 62 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;               coef exp(coef) se(coef)      z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; needle     1.07959   2.94348  0.31574  3.419 0.000628 ***</span></span>
<span><span class="co">#&gt; week_mood -0.03490   0.96570  0.01387 -2.517 0.011832 *  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; needle       2.9435     0.3397    1.5853    5.4654</span></span>
<span><span class="co">#&gt; week_mood    0.9657     1.0355    0.9398    0.9923</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.662  (se = 0.037 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 18.61  on 2 df,   p=9e-05</span></span>
<span><span class="co">#&gt; Wald test            = 16.62  on 2 df,   p=2e-04</span></span>
<span><span class="co">#&gt; Score (logrank) test = 17.49  on 2 df,   p=2e-04</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="model-c">Model C:<a class="anchor" aria-label="anchor" href="#model-c"></a>
</h4>
<p>For <strong>Model C</strong> we will also start with the lagged
weekly mood scores, however, we will use a different imputation
strategy: Interpolating between adjacent mood scores. Although Singer
and Willet (2003) suggest “resisting the temptation to design
sophisticated imputation algorithms,” their approach to interpolating
between adjacent mood scores was somewhat complex. Consequently, we need
to create our own function to suit the purpose, rather than using
existing functions like <code><a href="https://rdrr.io/pkg/zoo/man/na.approx.html" class="external-link">zoo::na.approx()</a></code> or
<code>imputeTS::na_ma()</code>.</p>
<p>Singer and Willet (2003) do not describe their approach in the text,
but their algorithm appears to be based on the following rules:</p>
<ol style="list-style-type: decimal">
<li>Trailing <code>NA</code>s should be imputed consecutively using the
most recent non-missing mood score.</li>
<li>Internal <code>NA</code>s should be imputed using the mean between
adjacent non-missing mood scores. For consecutive internal
<code>NA</code>s, following the first imputed mood score in the
sequence, every <code>NA</code> thereafter should be imputed using the
mean of the previous <code>NA</code> value’s imputed mood score and the
next non-missing mood score.</li>
<li>Imputed mood scores should be rounded to the nearest integer.</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">na_adjacent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># The while loop is used here to allow us to carry forward imputed mood scores</span></span>
<span>  <span class="co"># for consecutive internal NAs.</span></span>
<span>  <span class="va">x_avg</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x_avg</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://slider.r-lib.org/reference/slide2.html" class="external-link">pslide_dbl</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">x_avg</span>,</span>
<span>        <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_fill_missing.html" class="external-link">vec_fill_missing</a></span><span class="op">(</span><span class="va">x_avg</span>, direction <span class="op">=</span> <span class="st">"down"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_fill_missing.html" class="external-link">vec_fill_missing</a></span><span class="op">(</span><span class="va">x_avg</span>, direction <span class="op">=</span> <span class="st">"up"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      \<span class="op">(</span><span class="va">.x</span>, <span class="va">.x_fill_down</span>, <span class="va">.x_fill_up</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>          <span class="co"># Rule 1:</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="va">.x_fill_down</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>          <span class="co"># Rule 2:</span></span>
<span>          <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.x_fill_up</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">.x_fill_up</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">.x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span>,</span>
<span>      .before <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      .after <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>      .complete <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Rule 3. We are not using round() here because it goes to the even digit when</span></span>
<span>    <span class="co"># rounding off a 5, rather than always going upward.</span></span>
<span>    <span class="va">x_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">x_avg</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">1</span> <span class="op">&lt;</span> <span class="fl">.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">x_avg</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">x_avg</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">x_avg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">x_avg</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we can impute the lagged weekly mood scores using the
<code>na_adjacent()</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_adjacent</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2_prevweek</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># It's important to include the final follow-up when imputing between</span></span>
<span>    <span class="co"># adjacent mood scores, otherwise cases where the second last score is an</span></span>
<span>    <span class="co"># internal NA will fill down instead of using the mean between adjacent mood</span></span>
<span>    <span class="co"># scores. However, afterwards the final follow-up can be dropped.</span></span>
<span>    mood_adjacent_lag <span class="op">=</span> <span class="fu">na_adjacent</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mood_previous_week</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">last</a></span><span class="op">(</span><span class="va">mood</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">13</span><span class="op">]</span>,</span>
<span>    <span class="co"># We also want the non-lagged mood scores for later, which we impute using</span></span>
<span>    <span class="co"># similar logic.</span></span>
<span>    mood_adjacent <span class="op">=</span> <span class="fu">na_adjacent</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">mood_previous_week</span><span class="op">)</span>, <span class="va">mood</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Here is a small preview of the difference between the imputation strategies</span></span>
<span><span class="co"># for Models B and C:</span></span>
<span><span class="va">cocaine_relapse_2_adjacent</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">544</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">followup</span>, <span class="va">mood_previous_week</span><span class="op">:</span><span class="va">mood_adjacent_lag</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 5</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   id [1]</span></span></span>
<span><span class="co">#&gt;    id    followup mood_previous_week mood_previous_week_fill mood_adjacent_lag</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 544          1                 40                      40                40</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 544          2                 40                      40                40</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 544          3                 38                      38                38</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 544          4                 27                      27                27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 544          5                 <span style="color: #BB0000;">NA</span>                      27                25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 544          6                 22                      22                22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 544          7                 <span style="color: #BB0000;">NA</span>                      22                21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 544          8                 <span style="color: #BB0000;">NA</span>                      22                21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 544          9                 20                      20                20</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 544         10                 <span style="color: #BB0000;">NA</span>                      20                25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> 544         11                 30                      30                30</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> 544         12                 28                      28                28</span></span></code></pre></div>
<p>Next, to prepare the <code>cocaine_relapse_2_adjacent</code> data for
modelling, we will again transform it into counting process format;
however, for Model C each “at-risk” time interval will be one day long.
Following Singer and Willet (2003), we will construct a
<code>day_mood</code> variable by linearly interpolating between
adjacent weekly values to yield daily values, and then assigning to each
given day the mood value we imputed for the immediate prior day.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cocaine_relapse_2_adjacent_cp</span> <span class="op">&lt;-</span> <span class="va">cocaine_relapse_2_adjacent</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">followup</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span></span>
<span>    day_end <span class="op">=</span> <span class="op">(</span><span class="va">followup</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">7</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span>,</span>
<span>    day_start <span class="op">=</span> <span class="va">day_end</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>    days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">days</span><span class="op">)</span>,</span>
<span>    censor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">censor</span><span class="op">)</span>,</span>
<span>    event <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">day_end</span> <span class="op">==</span> <span class="va">days</span> <span class="op">&amp;</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>      true <span class="op">=</span> <span class="fl">1</span>, false <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    needle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">needle</span><span class="op">)</span>,</span>
<span>    mood_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mood_adjacent_lag</span>, <span class="va">mood_adjacent</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span>,</span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">day_start</span>, <span class="va">day_end</span>, <span class="va">days</span>, .after <span class="op">=</span> <span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">day_end</span> <span class="op">&lt;=</span> <span class="va">days</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cocaine_relapse_2_adjacent_cp</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4,948 × 9</span></span></span>
<span><span class="co">#&gt;    id    day_start day_end  days followup censor event needle mood_day</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 501           0       1    12        1      0     0      1     29  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 501           1       2    12        1      0     0      1     29.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 501           2       3    12        1      0     0      1     30.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 501           3       4    12        1      0     0      1     31.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 501           4       5    12        1      0     0      1     31.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 501           5       6    12        1      0     0      1     32.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 501           6       7    12        1      0     0      1     33.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 501           7       8    12        2      0     0      1     34  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 501           8       9    12        2      0     0      1     31.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 501           9      10    12        2      0     0      1     29.7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,938 more rows</span></span></span></code></pre></div>
<p>Now we can fit Model C.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">day_start</span>, <span class="va">day_end</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">needle</span> <span class="op">+</span> <span class="va">mood_day</span>, </span>
<span>  data <span class="op">=</span> <span class="va">cocaine_relapse_2_adjacent_cp</span>,</span>
<span>  ties <span class="op">=</span> <span class="st">"efron"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_C</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(day_start, day_end, event) ~ needle + mood_day, </span></span>
<span><span class="co">#&gt;     data = cocaine_relapse_2_adjacent_cp, ties = "efron")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 4948, number of events= 62 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              coef exp(coef) se(coef)      z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; needle    1.12077   3.06720  0.31700  3.536 0.000407 ***</span></span>
<span><span class="co">#&gt; mood_day -0.05438   0.94707  0.01489 -3.651 0.000261 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; needle      3.0672      0.326    1.6478    5.7091</span></span>
<span><span class="co">#&gt; mood_day    0.9471      1.056    0.9198    0.9751</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.695  (se = 0.036 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 25.52  on 2 df,   p=3e-06</span></span>
<span><span class="co">#&gt; Wald test            = 23.1  on 2 df,   p=1e-05</span></span>
<span><span class="co">#&gt; Score (logrank) test = 24.04  on 2 df,   p=6e-06</span></span></code></pre></div>
<p>Table 15.2, page 555:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TODO</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="nonproportional-hazards-models-via-stratification">15.2 Nonproportional Hazards Models via Stratification<a class="anchor" aria-label="anchor" href="#nonproportional-hazards-models-via-stratification"></a>
</h2>
<p>Figure 15.2, page 559:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># FIXME: The upper limit of the data doesn't match the textbook.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">used_cocaine_age</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span> <span class="va">rural</span>, data <span class="op">=</span> <span class="va">first_cocaine</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    strata <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">strata</span>, <span class="st">"rural="</span><span class="op">)</span>,</span>
<span>    cumulative_hazard <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>    log_cumulative_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">cumulative_hazard</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>rural <span class="op">=</span> <span class="va">strata</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">log_cumulative_hazard</span>, linetype <span class="op">=</span> <span class="va">rural</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>Table 15.3, page 560:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first_cocaine_model_C from earlier is the first model</span></span>
<span><span class="va">first_cocaine_model_C</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(age_start, age_end, used_cocaine) ~ birthyr + </span></span>
<span><span class="co">#&gt;     used_marijuana + used_drugs + sold_marijuana + sold_drugs, </span></span>
<span><span class="co">#&gt;     data = first_cocaine_pp_C, ties = "efron")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                    coef exp(coef) se(coef)     z        p</span></span>
<span><span class="co">#&gt; birthyr         0.08493   1.08864  0.02183 3.890    1e-04</span></span>
<span><span class="co">#&gt; used_marijuana  2.45920  11.69542  0.28357 8.672  &lt; 2e-16</span></span>
<span><span class="co">#&gt; used_drugs      1.25110   3.49419  0.15656 7.991 1.34e-15</span></span>
<span><span class="co">#&gt; sold_marijuana  0.68989   1.99349  0.12263 5.626 1.84e-08</span></span>
<span><span class="co">#&gt; sold_drugs      0.76037   2.13908  0.13066 5.819 5.91e-09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Likelihood ratio test=944.5  on 5 df, p=&lt; 2.2e-16</span></span>
<span><span class="co">#&gt; n= 3312, number of events= 382</span></span>
<span></span>
<span><span class="va">first_cocaine_model_stratified</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  <span class="va">first_cocaine_model_C</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html" class="external-link">strata</a></span><span class="op">(</span><span class="va">rural</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">first_cocaine_model_nonrural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  <span class="va">first_cocaine_model_C</span>, subset <span class="op">=</span> <span class="va">rural</span> <span class="op">==</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">first_cocaine_model_rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  <span class="va">first_cocaine_model_C</span>, subset <span class="op">=</span> <span class="va">rural</span> <span class="op">==</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># TODO: Make table.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="nonproportional-hazards-models-via-interactions-with-time">15.3 Nonproportional Hazards Models via Interactions with Time<a class="anchor" aria-label="anchor" href="#nonproportional-hazards-models-via-interactions-with-time"></a>
</h2>
<p>Table 15.4 page 566:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TODO</span></span>
<span><span class="va">psychiatric_discharge</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 174 × 4</span></span></span>
<span><span class="co">#&gt;    id     days censor treatment_plan</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2         3      0              1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 8        46      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 73       30      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 76       45      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 78       22      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 79       50      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 81       59      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 83       44      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 95       44      0              1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 117      22      0              0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 164 more rows</span></span></span></code></pre></div>
<p>Figure 15.3 page 567:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># FIXME: The upper limit of the data doesn't match the textbook.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">days</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span> <span class="va">treatment_plan</span>, data <span class="op">=</span> <span class="va">psychiatric_discharge</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    strata <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">strata</span>, <span class="st">"treatment_plan="</span><span class="op">)</span>,</span>
<span>    cumulative_hazard <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>    log_cumulative_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">cumulative_hazard</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>treatment_plan <span class="op">=</span> <span class="va">strata</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">log_cumulative_hazard</span>, linetype <span class="op">=</span> <span class="va">treatment_plan</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">.25</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">77</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># TODO: Bottom panel</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="regression-diagnostics">15.4 Regression Diagnostics<a class="anchor" aria-label="anchor" href="#regression-diagnostics"></a>
</h2>
<p>Figure 15.4 page 573:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rearrest</span> <span class="op">&lt;-</span> <span class="va">rearrest</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rank_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="va">months</span>, ties.method <span class="op">=</span> <span class="st">"average"</span><span class="op">)</span>, .after <span class="op">=</span> <span class="st">"months"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rearrest_null_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">months</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">rearrest</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rearrest_full_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  <span class="va">rearrest_null_model</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="va">person_crime</span> <span class="op">+</span> <span class="va">property_crime</span> <span class="op">+</span> <span class="va">age</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rearrest_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  null <span class="op">=</span> <span class="va">rearrest_null_model</span>,</span>
<span>  full <span class="op">=</span> <span class="va">rearrest_full_model</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rearrest_fits</span> <span class="op">&lt;-</span> <span class="va">rearrest_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    \<span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>martingale <span class="op">=</span> <span class="st">"martingale"</span>, deviance <span class="op">=</span> <span class="st">"deviance"</span><span class="op">)</span>,</span>
<span>        \<span class="op">(</span><span class="va">.y</span><span class="op">)</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span></span>
<span>          <span class="va">.x</span>, data <span class="op">=</span> <span class="va">rearrest</span>, type.predict <span class="op">=</span> <span class="st">"lp"</span>, type.residuals <span class="op">=</span> <span class="va">.y</span></span>
<span>        <span class="op">)</span>,</span>
<span>        .id <span class="op">=</span> <span class="st">".resid_type"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span>names_to <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">model</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"null"</span>, <span class="st">"full"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    censored <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">censor</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">rearrest_fits</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.resid_type</span> <span class="op">==</span> <span class="st">"martingale"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">.25</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">censored</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'loess' and formula = 'y ~ x'</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<p>Figure 15.5 page 577:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/stem.html" class="external-link">stem</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="va">rearrest_full_model</span>, type <span class="op">=</span> <span class="st">"deviance"</span><span class="op">)</span>, scale <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   The decimal point is 1 digit(s) to the left of the |</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   -22 | 09</span></span>
<span><span class="co">#&gt;   -20 | 21</span></span>
<span><span class="co">#&gt;   -18 | 6491</span></span>
<span><span class="co">#&gt;   -16 | 969321</span></span>
<span><span class="co">#&gt;   -14 | 54216</span></span>
<span><span class="co">#&gt;   -12 | 87654741</span></span>
<span><span class="co">#&gt;   -10 | 208776542110</span></span>
<span><span class="co">#&gt;    -8 | 99852176544</span></span>
<span><span class="co">#&gt;    -6 | 876322098874400</span></span>
<span><span class="co">#&gt;    -4 | 444443332877644210</span></span>
<span><span class="co">#&gt;    -2 | 85009955411</span></span>
<span><span class="co">#&gt;    -0 | 997597551</span></span>
<span><span class="co">#&gt;     0 | 268979</span></span>
<span><span class="co">#&gt;     2 | 0318</span></span>
<span><span class="co">#&gt;     4 | 133678802337</span></span>
<span><span class="co">#&gt;     6 | 2688919</span></span>
<span><span class="co">#&gt;     8 | 1136690012233889999</span></span>
<span><span class="co">#&gt;    10 | 122334724789</span></span>
<span><span class="co">#&gt;    12 | 0115</span></span>
<span><span class="co">#&gt;    14 | 0228055578</span></span>
<span><span class="co">#&gt;    16 | 03795</span></span>
<span><span class="co">#&gt;    18 | 2336</span></span>
<span><span class="co">#&gt;    20 | 0735</span></span>
<span><span class="co">#&gt;    22 | 6</span></span>
<span><span class="co">#&gt;    24 | 00</span></span>
<span><span class="co">#&gt;    26 | 7</span></span>
<span></span>
<span><span class="va">rearrest_fits</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"full"</span> <span class="op">&amp;</span> <span class="va">.resid_type</span> <span class="op">==</span> <span class="st">"deviance"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.fitted</span>, y <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">.25</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">censored</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<p>Figure 15.6 page 580:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># augment.coxph is bugged and won't return the .resid column when using</span></span>
<span><span class="co"># `newdata`, likely related to this issue: https://github.com/tidymodels/broom/issues/937</span></span>
<span><span class="co"># So this code doesn't work:</span></span>
<span><span class="co"># augment(</span></span>
<span><span class="co">#   rearrest_full_model,</span></span>
<span><span class="co">#   newdata = filter(rearrest, censor == 0),</span></span>
<span><span class="co">#   type.predict = "lp",</span></span>
<span><span class="co">#   type.residuals = "schoenfeld"</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># Likewise, `data` can't be used because it expects the full dataset; thus, it</span></span>
<span><span class="co"># will error out even when using the filtered data.</span></span>
<span></span>
<span><span class="co"># However, updating the model first does work:</span></span>
<span><span class="co"># Schoenfeld residuals only pertain to those who experience the event, so we need</span></span>
<span><span class="co"># to update the model before retrieving them, and only use a subset of the data</span></span>
<span><span class="co"># when getting predictions.</span></span>
<span><span class="va">rearrest_full_model</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span>subset <span class="op">=</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rearrest</span>, <span class="va">censor</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    type.predict <span class="op">=</span> <span class="st">"lp"</span>,</span>
<span>    type.residuals <span class="op">=</span> <span class="st">"schoenfeld"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">.resid</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_wider.html" class="external-link">unnest_wider</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">.resid</span>, names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">".resid"</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"predictor"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">".resid"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    predictor <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">predictor</span>, <span class="st">".resid_"</span><span class="op">)</span>,</span>
<span>    predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>      <span class="va">predictor</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person_crime"</span>, <span class="st">"property_crime"</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">rank_time</span>, y <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">.25</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span>, span <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">predictor</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, labeller <span class="op">=</span> <span class="va">label_both</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>n.breaks <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggh4x</span><span class="fu">::</span><span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/facetted_pos_scales.html" class="external-link">facetted_pos_scales</a></span><span class="op">(</span></span>
<span>      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">predictor</span> <span class="op">==</span> <span class="st">"person_crime"</span> <span class="op">~</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="va">predictor</span> <span class="op">==</span> <span class="st">"property_crime"</span> <span class="op">~</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>          n.breaks <span class="op">=</span> <span class="fl">7</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="va">predictor</span> <span class="op">==</span> <span class="st">"age"</span> <span class="op">~</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">175</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'loess' and formula = 'y ~ x'</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>Figure 15.7 page 583:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TODO: set y-axis scales to match textbook.</span></span>
<span><span class="va">rearrest_full_model</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">rearrest</span>,</span>
<span>    type.predict <span class="op">=</span> <span class="st">"lp"</span>,</span>
<span>    type.residuals <span class="op">=</span> <span class="st">"score"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">.resid</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_wider.html" class="external-link">unnest_wider</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">.resid</span>, names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">".resid"</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"predictor"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">".resid"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    predictor <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">predictor</span>, <span class="st">".resid_"</span><span class="op">)</span>,</span>
<span>    predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>      <span class="va">predictor</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person_crime"</span>, <span class="st">"property_crime"</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    censored <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">censor</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">rank_time</span>, y <span class="op">=</span> <span class="va">.resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">.25</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">censored</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">predictor</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, labeller <span class="op">=</span> <span class="va">label_both</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="competing-risks">15.5 Competing Risks<a class="anchor" aria-label="anchor" href="#competing-risks"></a>
</h2>
<p>Figure 15.8 page 589:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">judges_null_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  dead <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">tenure</span>, <span class="va">dead</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">judges</span><span class="op">)</span>,</span>
<span>  retired <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">tenure</span>, <span class="va">retired</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">judges</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">judges_null_models_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>  <span class="va">judges_null_models</span>,</span>
<span>  \<span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">.x</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit0.html" class="external-link">survfit0</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cumulative_hazard <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time</span>, survival <span class="op">=</span> <span class="va">estimate</span>, <span class="va">cumulative_hazard</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>        cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">survival</span>, <span class="va">cumulative_hazard</span><span class="op">)</span>,</span>
<span>        names_to <span class="op">=</span> <span class="st">"statistic"</span>,</span>
<span>        values_to <span class="op">=</span> <span class="st">"estimate"</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate and tidy smoothed hazards</span></span>
<span><span class="va">judges_kernel_smoothed_hazards_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    judges_dead <span class="op">=</span> <span class="va">judges</span><span class="op">$</span><span class="va">dead</span>,</span>
<span>    judges_retired <span class="op">=</span> <span class="va">judges</span><span class="op">$</span><span class="va">retired</span></span>
<span>  <span class="op">)</span>,</span>
<span>  \<span class="op">(</span><span class="va">event</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">kernel_smoothed_hazard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html" class="external-link">muhaz</a></span><span class="op">(</span></span>
<span>      <span class="va">judges</span><span class="op">$</span><span class="va">tenure</span>,</span>
<span>      <span class="va">event</span>,</span>
<span>      min.time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">judges</span><span class="op">$</span><span class="va">tenure</span><span class="op">[</span><span class="va">event</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">6</span>,</span>
<span>      max.time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">judges</span><span class="op">$</span><span class="va">tenure</span><span class="op">[</span><span class="va">event</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">6</span>,</span>
<span>      bw.grid <span class="op">=</span> <span class="fl">6</span>,</span>
<span>      bw.method <span class="op">=</span> <span class="st">"global"</span>,</span>
<span>      b.cor <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>      kern <span class="op">=</span> <span class="st">"epanechnikov"</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">kernel_smoothed_hazard</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">"hazard"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in muhaz(judges$tenure, event, min.time = min(judges$tenure[event == : minimum time &gt; minimum Survival Time</span></span>
<span><span class="co">#&gt; Warning in muhaz(judges$tenure, event, min.time = min(judges$tenure[event == : minimum time &gt; minimum Survival Time</span></span>
<span></span>
<span><span class="co"># Combine estimates</span></span>
<span><span class="va">estimates_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_df</a></span><span class="op">(</span></span>
<span>  <span class="va">judges_null_models_tidy</span>, <span class="va">judges_kernel_smoothed_hazards_tidy</span>,</span>
<span>  \<span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>        <span class="va">statistic</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"survival"</span>, <span class="st">"cumulative_hazard"</span>, <span class="st">"hazard"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  .id <span class="op">=</span> <span class="st">"event"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">estimates_tidy</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">estimate</span>, linetype <span class="op">=</span> <span class="va">event</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data <span class="op">=</span> \<span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">statistic</span> <span class="op">!=</span> <span class="st">"hazard"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> \<span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">statistic</span> <span class="op">==</span> <span class="st">"hazard"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">statistic</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code></pre></div>
<p><img src="chapter-15_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p>Table 15.7 page 592:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">judges_model_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">tenure</span>, <span class="va">dead</span><span class="op">)</span> <span class="op">~</span> <span class="va">appointment_age</span> <span class="op">+</span> <span class="va">appointment_year</span>,</span>
<span>  data <span class="op">=</span> <span class="va">judges</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">judges_model_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">tenure</span>, <span class="va">retired</span><span class="op">)</span> <span class="op">~</span> <span class="va">appointment_age</span> <span class="op">+</span> <span class="va">appointment_year</span>,</span>
<span>  data <span class="op">=</span> <span class="va">judges</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">judges_model_C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">tenure</span>, <span class="va">left_appointment</span><span class="op">)</span> <span class="op">~</span> <span class="va">appointment_age</span> <span class="op">+</span> <span class="va">appointment_year</span>,</span>
<span>  data <span class="op">=</span> <span class="va">judges</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># TODO: Make table.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="late-entry-into-the-risk-set">15.6 Late Entry into the Risk Set<a class="anchor" aria-label="anchor" href="#late-entry-into-the-risk-set"></a>
</h2>
<p>Table 15.8 page 601:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model A ----</span></span>
<span></span>
<span><span class="co"># First we need to transform to a counting process format.</span></span>
<span><span class="va">physicians_event_times_A</span> <span class="op">&lt;-</span> <span class="va">physicians</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">exit</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We'll use survSplit() this time around.</span></span>
<span><span class="va">physicians_cp_A</span> <span class="op">&lt;-</span> <span class="va">physicians</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>event <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survSplit.html" class="external-link">survSplit</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">entry</span>, <span class="va">exit</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="va">_</span>,</span>
<span>    cut <span class="op">=</span> <span class="va">physicians_event_times_A</span>,</span>
<span>    end <span class="op">=</span> <span class="st">"exit"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The warning message here can be ignored.</span></span>
<span><span class="va">physicians_model_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">entry</span>, <span class="va">exit</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">part_time</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">age</span><span class="op">:</span><span class="va">exit</span>,</span>
<span>  data <span class="op">=</span> <span class="va">physicians_cp_A</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in coxph(Surv(entry, exit, event) ~ part_time + age + age:exit, : a</span></span>
<span><span class="co">#&gt; variable appears on both the left and right sides of the formula</span></span>
<span></span>
<span><span class="co"># Model B ----</span></span>
<span><span class="va">physicians_event_times_B</span> <span class="op">&lt;-</span> <span class="va">physicians</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">entry</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">exit</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">physicians_cp_B</span> <span class="op">&lt;-</span> <span class="va">physicians</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">entry</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>event <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survSplit.html" class="external-link">survSplit</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">entry</span>, <span class="va">exit</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="va">_</span>,</span>
<span>    cut <span class="op">=</span> <span class="va">physicians_event_times_B</span>,</span>
<span>    end <span class="op">=</span> <span class="st">"exit"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">physicians_model_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">entry</span>, <span class="va">exit</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">part_time</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">age</span><span class="op">:</span><span class="va">exit</span>,</span>
<span>  data <span class="op">=</span> <span class="va">physicians_cp_B</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in coxph(Surv(entry, exit, event) ~ part_time + age + age:exit, : a</span></span>
<span><span class="co">#&gt; variable appears on both the left and right sides of the formula</span></span>
<span></span>
<span><span class="co"># Model C ----</span></span>
<span><span class="va">physicians_cp_C</span> <span class="op">&lt;-</span> <span class="va">physicians</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    event <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span>,</span>
<span>    entry <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survSplit.html" class="external-link">survSplit</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">entry</span>, <span class="va">exit</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="va">_</span>,</span>
<span>    cut <span class="op">=</span> <span class="va">physicians_event_times_A</span>,</span>
<span>    end <span class="op">=</span> <span class="st">"exit"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">physicians_model_C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">entry</span>, <span class="va">exit</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">part_time</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">age</span><span class="op">:</span><span class="va">exit</span>,</span>
<span>  data <span class="op">=</span> <span class="va">physicians_cp_C</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in coxph(Surv(entry, exit, event) ~ part_time + age + age:exit, : a</span></span>
<span><span class="co">#&gt; variable appears on both the left and right sides of the formula</span></span>
<span></span>
<span><span class="co"># TODO: Make table and clean up code.</span></span></code></pre></div>
<div class="section level3">
<h3 id="using-late-entrants-to-introduce-alternative-metrics-for-clocking-time">15.6.2 Using Late Entrants to Introduce Alternative Metrics for
Clocking Time<a class="anchor" aria-label="anchor" href="#using-late-entrants-to-introduce-alternative-metrics-for-clocking-time"></a>
</h3>
<p>Table 15.9 page 604:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">monkeys_model_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">sessions</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span> <span class="va">initial_age</span> <span class="op">+</span> <span class="va">birth_weight</span> <span class="op">+</span> <span class="va">female</span>,</span>
<span>  data <span class="op">=</span> <span class="va">monkeys</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">monkeys_model_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">monkeys_model_A</span>, <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">end_age</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The warning message here can be ignored.</span></span>
<span><span class="va">monkeys_model_C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  <span class="va">monkeys_model_A</span>, <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">initial_age</span>, <span class="va">end_age</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">censor</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in coxph(formula = Surv(initial_age, end_age, 1 - censor) ~ initial_age</span></span>
<span><span class="co">#&gt; + : a variable appears on both the left and right sides of the formula</span></span>
<span></span>
<span><span class="co"># TODO: Make table.</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael McCarthy.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
